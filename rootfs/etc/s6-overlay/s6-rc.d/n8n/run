#!/usr/bin/with-contenv bashio
# Home Assistant Community Add-on: n8n
# Runs the n8n service

chmod +x "$0"
bashio::log.level "debug"

bashio::log.info "Starting n8n service..."

N8N_DATA_DIR="/data/n8n_data"
ENV_FILE="${N8N_DATA_DIR}/.env"

# Charger les variables depuis .env
if [ -f "${ENV_FILE}" ]; then
  bashio::log.info "Chargement des variables depuis ${ENV_FILE}..."
  bashio::log.debug "Contenu de ${ENV_FILE} avant chargement :"
  cat "${ENV_FILE}" | while read -r line; do bashio::log.debug "$line"; done
  set -a  # Active l'export automatique des variables
  source "${ENV_FILE}" || { bashio::log.error "Échec du chargement de ${ENV_FILE}"; exit 1; }
  set +a
  bashio::log.debug "Variables d'environnement après chargement :"
  env | grep N8N | while read -r line; do bashio::log.debug "$line"; done
else
  bashio::log.error "Fichier ${ENV_FILE} introuvable !"
  exit 1
fi

# Vérifier les variables essentielles
if [ -z "$N8N_HOST" ] || [ -z "$N8N_PORT" ] || [ -z "$N8N_WEBHOOK_URL" ]; then
  bashio::log.error "Variables essentielles manquantes (N8N_HOST, N8N_PORT, N8N_WEBHOOK_URL) !"
  exit 1
fi

# Vérifier N8N_USER_FOLDER
bashio::log.debug "N8N_USER_FOLDER défini à : ${N8N_USER_FOLDER}"
if [ ! -d "${N8N_USER_FOLDER}" ]; then
  bashio::log.error "Répertoire ${N8N_USER_FOLDER} n'existe pas !"
  exit 1
fi

bashio::log.info "Lancement de n8n avec les variables d'environnement..."
exec n8n start